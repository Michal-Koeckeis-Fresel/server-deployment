# Fluent Bit Configuration for BunkerWeb
# Save this as /data/BunkerWeb/fluent-config/fluent-bit.conf

[SERVICE]
    Flush         1
    Daemon        Off
    Log_Level     info
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    storage.path  /fluent-bit/log/storage/

# Input: Forward protocol (receives logs from Docker containers)
[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              24224
    Buffer_Chunk_Size 1M
    Buffer_Max_Size   6M

# Parser: JSON parser for Docker container logs
[PARSER]
    Name         docker_json
    Format       json
    Time_Key     time
    Time_Format  %Y-%m-%dT%H:%M:%S.%L
    Time_Keep    On

# Filter: Add hostname and clean up log data
[FILTER]
    Name                modify
    Match               *
    Add                 hostname ${HOSTNAME}
    Add                 service bunkerweb

# Filter: Parse JSON logs if they exist
[FILTER]
    Name                parser
    Match               bunkerweb.*
    Key_Name            log
    Parser              docker_json
    Reserve_Data        On
    Preserve_Key        On

# Output: Write to local files (organized by container)
[OUTPUT]
    Name                file
    Match               bunkerweb.bunkerweb
    Path                /fluent-bit/log/
    File                bunkerweb-proxy.log
    Format              template
    Template            {time} [{level}] {container_name}: {log}

[OUTPUT]
    Name                file
    Match               bunkerweb.bw-scheduler
    Path                /fluent-bit/log/
    File                bunkerweb-scheduler.log
    Format              template
    Template            {time} [{level}] {container_name}: {log}

[OUTPUT]
    Name                file
    Match               bunkerweb.bw-ui
    Path                /fluent-bit/log/
    File                bunkerweb-ui.log
    Format              template
    Template            {time} [{level}] {container_name}: {log}

[OUTPUT]
    Name                file
    Match               bunkerweb.bw-autoconf
    Path                /fluent-bit/log/
    File                bunkerweb-autoconf.log
    Format              template
    Template            {time} [{level}] {container_name}: {log}

# Output: All logs to a combined file
[OUTPUT]
    Name                file
    Match               bunkerweb.*
    Path                /fluent-bit/log/
    File                bunkerweb-all.log
    Format              template
    Template            {time} [{level}] {container_name}: {log}

# Output: JSON format for log aggregation systems (optional)
[OUTPUT]
    Name                file
    Match               bunkerweb.*
    Path                /fluent-bit/log/json/
    File                bunkerweb.json
    Format              json_lines

# Output: Standard output for debugging (uncomment for troubleshooting)
# [OUTPUT]
#     Name                stdout
#     Match               bunkerweb.*
#     Format              template
#     Template            {time} [{level}] {container_name}: {log}

# Advanced outputs (uncomment and configure as needed):

# Output: Forward to another Fluent Bit/Fluentd instance
# [OUTPUT]
#     Name                forward
#     Match               bunkerweb.*
#     Host                your-log-server.com
#     Port                24224

# Output: Send to Elasticsearch
# [OUTPUT]
#     Name                es
#     Match               bunkerweb.*
#     Host                elasticsearch.example.com
#     Port                9200
#     Index               bunkerweb-logs
#     Type                _doc

# Output: Send to Splunk
# [OUTPUT]
#     Name                splunk
#     Match               bunkerweb.*
#     Host                splunk.example.com
#     Port                8088
#     Splunk_Token        your-hec-token

# Output: Send to AWS CloudWatch
# [OUTPUT]
#     Name                cloudwatch_logs
#     Match               bunkerweb.*
#     region              us-east-1
#     log_group_name      /aws/bunkerweb/logs
#     log_stream_prefix   bunkerweb-

# Output: Send to Datadog
# [OUTPUT]
#     Name                datadog
#     Match               bunkerweb.*
#     Host                http-intake.logs.datadoghq.com
#     TLS                 on
#     apikey              your-datadog-api-key
#     dd_service          bunkerweb
#     dd_source           docker
#     dd_tags             env:production